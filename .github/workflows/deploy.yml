name: Deploy Website to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install SSH and Rsync
      - name: Install SSH and Rsync
        run: sudo apt-get update && sudo apt-get install -y openssh-client rsync

      # Step 3: Add EC2 private key
      - name: Add private key
        run: |
          echo "${{ secrets.EC2_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      # Step 4: Ensure remote directory exists
      - name: Create remote folder
        run: |
          ssh -i private_key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_IP }} "mkdir -p ~/website"

      # Step 5: Sync website files to EC2
      - name: Sync files to EC2
        run: |
          rsync -avz --delete --exclude=".git" --exclude=".github" -e "ssh -i private_key.pem -o StrictHostKeyChecking=no" ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_IP }}:~/website/

      # Step 6: Move files to Apache root and set permissions
      - name: Deploy to Apache root
        run: |
          ssh -i private_key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_IP }} "
          sudo cp -r ~/website/* /var/www/html/ &&
          sudo chown -R www-data:www-data /var/www/html/
          "

      # Step 7: Restart Apache
      - name: Restart Apache
        run: |
          ssh -i private_key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_IP }} "sudo systemctl restart apache2"





